<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="card">
		<img src="res/EASA_Logo.png" class="card-img-top">
		<div class="card-body">
			<h1 class="card-title">Compare XML Rulesets</h1>
			<div class="dropdown" id="dropdown-btn">
		        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
		        Select ruleset
		        </button>
		        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
		            <a class="dropdown-item" onclick="set_ruleset('2017.373 ATM / ANS')">2017.373 ATM / ANS</a>
		            <a class="dropdown-item" onclick="set_ruleset('923.2012 - SERA')">923.2012 - SERA</a>
		            <a class="dropdown-item" onclick="set_ruleset('139.2014 - ADR')">139.2014 - ADR</a>
		            <a class="dropdown-item" onclick="set_ruleset('965.2012 - Air Operations')">965.2012 - Air Operations</a>
	        </div>

	        <div class="list-group" id="listGroup">
	        	<h4 id="list-group-title"></h4>
	        	<div id="atm-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>February 2023</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>November 2022</span>
		        	</label>
	        	</div>
	        	<div id="sera-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>March 2020</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>Oktober 2022</span>
		        	</label>
	        	</div>
	        </div>
	        <div>
	    		<button id="compare-btn" onclick="compare()" style="display:none" disabled>Compare></button>
    		</div>
			<div id="display-changes">
			</div>
	    </div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	
	<script>
		let num_check = 0;

		// setup the ruleset based on selection from dropdown menu
		function set_ruleset(val){
			uncheck()
			chg_text('list-group-title', val);
			document.getElementById('atm-grp').style.display = "none";
			document.getElementById('sera-grp').style.display = "none";


			switch(val){
				case "2017.373 ATM / ANS":
					document.getElementById('atm-grp').style.display = "block";
					break;
				case "923.2012 - SERA":
					document.getElementById('sera-grp').style.display = "block";
					break;
				case "139.2014 - ADR":
					break;
				case "965.2012 - Air Operations":
					break;
				default:
					console.log("error");
			}

			document.getElementById('compare-btn').style.display = "inline";
		}

		function chg_text(e, txt){
			document.getElementById(e).innerHTML = txt;
		}

		// uncheck all checkboxes
		function uncheck(){
			disable_btn(true) // disable 'compare' button
			const checkboxes = document.getElementsByClassName('form-check-input')
			for(let i = 0; i < checkboxes.length; i++){
				checkboxes[i].checked = false
			}
		}

		// monitor how many of the check boxes are checked
		function check_boxes(e){

			if(e.checked){
				num_check+=1
			}else{
				num_check-=1
			}

			if (num_check === 2){
				disable_btn(false)
			}else{
				disable_btn(true)
				
			}
		}

		// disable or enable "compare button"
		function disable_btn(b){
			if(b){
				document.getElementById('compare-btn').disabled = true;
			}else{
				document.getElementById('compare-btn').disabled = false;
				num_check = 0
			}
		}

		function hide_selection(){
			document.getElementById('dropdown-btn').style.display = "none";
			document.getElementById('listGroup').style.display = "none";
			document.getElementById('compare-btn').style.display = "none";
		}

		function get_comparitors(){
			const checkboxes = document.getElementsByClassName('form-check-input');
			const checked = [];
			checked.push(document.getElementById('list-group-title').innerHTML);

			for(let i = 0; i < checkboxes.length; i++){
				if(checkboxes[i].checked === true){
					checked.push(checkboxes[i].parentElement.children[1].innerHTML);
				}
			}
			return checked;
		}

		function compare(){
			const checked = get_comparitors()
			hide_selection()
			let file_new = ""
			let file_old = ""
			let parser = new DOMParser();

			switch(checked[0]){
				case "2017.373 ATM / ANS":
					file_new = "/xml/atm/" + checked[1] + ".xml";
					file_old = "/xml/atm/" + checked[2] + ".xml";

					xmlFiles = [file_new, file_old];

					const load = (file) => new Promise((resolve) => {
						const request = new XMLHttpRequest()
						request.open("GET", file)
						request.onload = function() {
							resolve(parser.parseFromString(request.responseText, "text/xml"));
						}
						request.send()
					})

					Promise
						.all(xmlFiles.map((file) => load(file)))
						.then(function(root) {
							const d_new = root[0]
							const d_old = root[1]
							e = document.getElementById("display-changes");
							document.getElementsByClassName('card-title')[0].innerHTML = "Changes:"

							/*e.appendChild(document.createTextNode(root[0].getElementsByTagName('er:topic')[200].getAttribute('source-title')));*/
							let topics_new = []
							let topics_old = []
							let erules_new = []
							let erules_old = []
							let chg_topics = []
							let rem_topics = []
							let new_topics = []
							// This array controls which regulatory subjects are included
							let subs = ['Part-ATM/ANS.AR;', 'Part-ATM/ANS.OR;', 'Part-ATS;', 'Part-MET;', 'Part-AIS;', 'Part-DAT;', 'Part-CNS;', 'Part-ATFM;', 'Part-ASM;', 'Part-ASD;', 'Part-FDP;', 'Part-NM;', 'Part-PERS;'];
							
							for(let i = 0; i < d_new.getElementsByTagName('er:topic').length; i++){
								t = d_new.getElementsByTagName('er:topic')[i];
								if(t.getAttribute('TypeOfContent') != "AMC to IR (Acceptable means of compliance to implementing rule);" && subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_new.push(t);
									erules_new.push(t.getAttribute('ERulesId'))
								}
							}

							for(let i = 0; i < d_old.getElementsByTagName('er:topic').length; i++){
								t = d_old.getElementsByTagName('er:topic')[i];
								if(t.getAttribute('TypeOfContent') != "AMC to IR (Acceptable means of compliance to implementing rule);" && subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_old.push(t);
									erules_old.push(t.getAttribute('ERulesId'))
								}
							}
							
							if(topics_new.length > topics_old.length){
								let offset = 0
								for(let i = 0; i < topics_new.length; i++){
									// Check if the erule is new
									if(erules_new[i] != erules_old[i+offset]){
										//offset because erules old is smaller than erules new
										if(!erules_old.includes(erules_new[i])){
											//new content added to the last version
											new_topics.push(topics_new[i].getAttribute('source-title'));
										}else{
											//the old file has the new erule later, hence an erule has been removed from the old one
											if(!erules_new.includes(erules_old[i])){
												rem_topics.push(topics_old[i].getAttribute('source-title'))
											}
										}

										offset -= 1
									}else{
										//erules are the same, so we check for changed text
										p_lst1 = [...topics_new[i].getElementsByTagName("para")];
										let text1 = ""
										p_lst1.forEach(function(d){
											text1 += d.textContent;
										});
										p_lst2 = [...topics_new[i].getElementsByTagName("para")];
										let text2 = ""
										p_lst2.forEach(function(d){
											text2 += d.textContent;
										});

										if(text1 != text2){
											chg_topics.push(topics_new[i].getAttribute('source-title'))
										}
									}
								}
							}/*else if(topics_old.length > topics_new.length){
								let offset = 0
								for(let i = 0; i < topics_old.length; i++){
									
									if(erules_old[i] != erules_new[i+offset]){
										offset -= 1
									}
								}
							}*/
							
							console.log("new: " + new_topics)
							console.log("changed: " + chg_topics)
							console.log("removed: " + rem_topics)

							
							


							/*for(let element in d_new.getElementsByTagName('er:topic')){
								if element.get('TypeOfContent') != '' or d_new.get('source-title')[0:2] in ('AM', 'GM'){
									console.log(element.get('TypeOfContent'))
								}
							}*/
						})

					//chg_text('list-group-title', "Changes:");
					//uncheck()
					//hide_selection()

					/*fetch_xml(file_new, file_old)
						.then(function(result) {
							console.log(result);
						})*/
					//console.log(xml1)
					//console.log("4: " + xml);
					/*console.log(xml_files[0].getElementsByTagName('er:topic')[200].getAttribute('source-title'));*/

					break;
				case "923.2012 - SERA":
					//let url_new = "/xml/atm/" + checked[1] + ".xml"
					//let url_old = "/xml/atm/" + checked[2] + ".xml"
					break;
				case "139.2014 - ADR":
					break;
				case "965.2012 - Air Operations":
					break;
				default:
					console.log("error");
			}
		}
	</script>
</body>
