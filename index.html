<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="card">
		<a href="index.html">
			<img src="res/EASA_Logo.png" class="card-img-top">
		</a>
		<div class="card-body">
			<!-- <h2 class="card-title">Compare XML Rulesets</h2> -->
			<div class="dropdown" id="dropdown-btn">
		        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
		        Select ruleset
		        </button>
		        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
		            <a class="dropdown-item" onclick="set_ruleset('2017.373 ATM / ANS')">2017.373 ATM / ANS</a>
		            <a class="dropdown-item" onclick="set_ruleset('2023/1769 ATM / ANS EQ')">2023/1769 ATM / ANS EQ</a>
		            <a class="dropdown-item" onclick="set_ruleset('923.2012 - SERA')">923.2012 - SERA</a>
		            <a class="dropdown-item" onclick="set_ruleset('139.2014 - ADR')">139.2014 - ADR</a>
		            <a class="dropdown-item" onclick="set_ruleset('965.2012 - Air Operations')">965.2012 - Air Operations</a>
	        </div>

	        <div class="list-group" id="listGroup">
	        	<h4 id="list-group-title"></h4>
	        	<div id="atm-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>February 2023</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>November 2022</span>
		        	</label>
	        	</div>
	        	<div id="atm-eq-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>New version</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>November 2024</span>
		        	</label>
	        	</div>
	        	<div id="sera-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>New version</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>February 2023</span>
		        	</label>
	        	</div>
	        	<div id="adr-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>New version</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>June 2023</span>
		        	</label>
	        	</div>
	        	<div id="airops-grp" style="display:none">
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>June 2023</span>
		        	</label>
		        	<label class="list-group-item d-flex gap-2">
		        		<input class="form-check-input flex-shrink-0" onclick="check_boxes(this)" type="checkbox" value>
		        		<span>November 2022</span>
		        	</label>
	        	</div>
	        </div>
	        <div>
	    		<button id="compare-btn" onclick="compare()" style="display:none" disabled>Compare</button>
    		</div>
			<div id="display-changes">
				<h5 id=h-new></h5>
				<ul id="ul-new"></ul>
				<h5 id=h-chg></h5>
				<ul id="ul-chg"></ul>
				<h5 id=h-rem></h5>
				<ul id="ul-rem"></ul>
			</div>
	    </div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	
	<script>
		let num_check = 0;
		let compareBtn = document.getElementById('compare-btn');

		// setup the ruleset based on selection from dropdown menu
		function set_ruleset(val){
			uncheck()
			chg_text('list-group-title', val);
			document.getElementById('atm-grp').style.display = "none";
			document.getElementById('atm-eq-grp').style.display = "none";
			document.getElementById('sera-grp').style.display = "none";
			document.getElementById('adr-grp').style.display = "none";
			document.getElementById('airops-grp').style.display = "none";


			switch(val){
				case "2017.373 ATM / ANS":
					document.getElementById('atm-grp').style.display = "block";
					break;
				case "2023/1769 ATM / ANS EQ":
					document.getElementById('atm-eq-grp').style.display = "block";
					break;
				case "923.2012 - SERA":
					document.getElementById('sera-grp').style.display = "block";
					break;
				case "139.2014 - ADR":
					document.getElementById('adr-grp').style.display = "block";
					break;
				case "965.2012 - Air Operations":
					document.getElementById('airops-grp').style.display = "block";
					break;
				default:
					console.log("error");
			}

			compareBtn.style.display = "inline";
		}

		function chg_text(e, txt){
			document.getElementById(e).innerHTML = txt;
		}

		// uncheck all checkboxes
		function uncheck(){
			num_check=0;
			chg_btn_state(compareBtn, true)

			const checkboxes = document.getElementsByClassName('form-check-input')
			for(let i = 0; i < checkboxes.length; i++){
				checkboxes[i].checked = false
			}
		}

		// monitor how many of the check boxes are checked
		function check_boxes(e){
			if(e.checked){
				num_check+=1
			}else{
				num_check-=1
			}
			
			if (num_check === 2){
				// disable_btn(false)
				chg_btn_state(compareBtn, false);
			}
			else{
				// disable_btn(true)
				chg_btn_state(compareBtn, true);
			}
		}

		function chg_btn_state(btn, bool){
			btn.disabled = bool;
		}

		function hide_selection(){
			document.getElementById('dropdown-btn').style.display = "none";
			document.getElementById('listGroup').style.display = "none";
			compareBtn.style.display = "none";
			//matrixBtn.style.display = "none";
		}

		function get_comparitors(){
			const checkboxes = document.getElementsByClassName('form-check-input');
			const checked = [];
			checked.push(document.getElementById('list-group-title').innerHTML);

			for(let i = 0; i < checkboxes.length; i++){
				if(checkboxes[i].checked === true){
					checked.push(checkboxes[i].parentElement.children[1].innerHTML);
				}
			}
			return checked;
		}

		function compare(){
			const checked = get_comparitors()
			hide_selection()
			let file_new = ""
			let file_old = ""
			let parser = new DOMParser();

			switch(checked[0]){
				case "2017.373 ATM / ANS":
					file_new = "xml/atm/" + checked[1] + ".xml";
					file_old = "xml/atm/" + checked[2] + ".xml";

					xmlFiles = [file_new, file_old];

					var load = (file) => new Promise((resolve) => {
						const request = new XMLHttpRequest()
						request.open("GET", file)
						request.onload = function() {
							resolve(parser.parseFromString(request.responseText, "text/xml"));
						}
						request.send()
					})

					Promise
						.all(xmlFiles.map((file) => load(file)))
						.then(function(root) {
							const d_new = root[0]
							const d_old = root[1]

							e = document.getElementById("display-changes");
							const h_new = document.getElementById("h-new");
							const h_chg = document.getElementById("h-chg");
							const h_rem = document.getElementById("h-rem");
							h_new.innerHTML = "New Topics:"
							h_chg.innerHTML = "Changed Topics:"
							h_rem.innerHTML = "Removed Topics:"
							
							const ul_new = document.getElementById("ul-new");
							const ul_chg = document.getElementById("ul-chg");
							const ul_rem = document.getElementById("ul-rem");

							let topics_new = []
							let topics_old = []
							let erules_new = []
							let erules_old = []
							let chg_topics = []
							let rem_topics = []
							let new_topics = []
							let text_changes = []
							
							// This array controls which regulatory subjects are included
							let subs = ['Part-ATM/ANS.AR;', 'Part-ATM/ANS.OR;', 'Part-ATS;', 'Part-MET;', 'Part-AIS;', 'Part-DAT;', 'Part-CNS;', 'Part-ATFM;', 'Part-ASM;', 'Part-ASD;', 'Part-FDP;', 'Part-NM;', 'Part-PERS;'];
							
							// loop over the new xml file and adding topics amd erules
							for(let i = 0; i < d_new.getElementsByTagName('er:topic').length; i++){
								t = d_new.getElementsByTagName('er:topic')[i];
								if(subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_new.push(t);
									erules_new.push(t.getAttribute('ERulesId'))
								}
							}

							// loop over the old xml file and adding topics amd erules
							for(let i = 0; i < d_old.getElementsByTagName('er:topic').length; i++){
								t = d_old.getElementsByTagName('er:topic')[i];
								if(subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_old.push(t);
									erules_old.push(t.getAttribute('ERulesId'))
								}
							}

							let longest = Math.max(topics_new.length, topics_old.length);
							let n_offset = 0; // tracks the offset of the new xml iterator
							let o_offset = 0; // tracks the offset of the new xml iterator
							for(let i = 0; i < longest; i++){
								if(erules_new[i-n_offset] != erules_old[i-o_offset]){
									if(!erules_old.includes(erules_new[i-n_offset])){
									// New topic added
										new_topics.push(topics_new[i-n_offset].getAttribute('source-title'));
										o_offset += 1; 
										//offset 'old' iterator to remain the same, while we check the next topic in the new xml file
									}else if(!erules_new.includes(erules_old[i-o_offset])){
									// Old topic removed
										rem_topics.push(topics_old[i-o_offset].getAttribute('source-title'));
										n_offset += 1;
										//offset 'new' iterator to remain the same, while we check the next topic in the old xml file
									}
								}else{
									//erules are the same, so we check for changed text
									p_lst1 = [...topics_new[i-n_offset].getElementsByTagName("para")];
									let text1 = ""
									//p_lst1.shift();
									p_lst1.forEach(function(d){
										text1 += "<br>"+d.textContent;
									});

									p_lst2 = [...topics_old[i-o_offset].getElementsByTagName("para")];
									let text2 = ""
									//p_lst2.shift();
									p_lst2.forEach(function(d){
										text2 += "<br>"+d.textContent;
									});

									if(text1 != text2){
										let txt = [text1, text2];
										text_changes.push(txt);
										chg_topics.push(topics_new[i-n_offset].getAttribute('source-title'));
									}
								}
							}

							// Place content in HTML element
							for(var i = 0; i < new_topics.length; i++){
								let li = document.createElement("li");
								li.style.fontSize="15px";
								li.innerHTML = new_topics[i];
								ul_new.appendChild(li)
							}
							for(var i = 0; i < chg_topics.length; i++){
								let li = document.createElement("li");
								let p = document.createElement("p");
								p.style.fontSize="12px";
								p.style.paddingTop="10px";
								p.style.paddingBottom="10px";								
								p.style.display = "none";
								li.onclick = function() { if(li.firstElementChild.style.display === "none"){li.firstElementChild.style.display = "block";
									}else{li.firstElementChild.style.display = "none";} 
								};
								li.innerHTML = chg_topics[i];
								p.innerHTML = "<b>New text:</b>"+text_changes[i][0]
									+"<br><br><b>Old text:</b>"+text_changes[i][1];
								li.appendChild(p);
								ul_chg.appendChild(li)
							}
							
							for(var i = 0; i < rem_topics.length; i++){
								let li = document.createElement("li");
								li.innerHTML = rem_topics[i];
								ul_rem.appendChild(li)
							}
						})

					break;
				case "2023/1769 ATM / ANS EQ":
					break;
				case "923.2012 - SERA":
					break;
				case "139.2014 - ADR":
					break;
				case "965.2012 - Air Operations":
					file_new = "xml/airops/" + checked[1] + ".xml";
					file_old = "xml/airops/" + checked[2] + ".xml";

					xmlFiles = [file_new, file_old];

					var load = (file) => new Promise((resolve) => {
						const request = new XMLHttpRequest()
						request.open("GET", file)
						request.onload = function() {
							resolve(parser.parseFromString(request.responseText, "text/xml"));
						}
						request.send()
					})

					Promise
						.all(xmlFiles.map((file) => load(file)))
						.then(function(root) {
							const d_new = root[0]
							const d_old = root[1]
							/*document.getElementsByClassName('card-title')[0].innerHTML =
								document.getElementById('list-group-title').innerHTML;*/
							e = document.getElementById("display-changes");
							const h_new = document.getElementById("h-new");
							const h_chg = document.getElementById("h-chg");
							const h_rem = document.getElementById("h-rem");
							h_new.innerHTML = "New Topics:"
							h_chg.innerHTML = "Changed Topics:"
							h_rem.innerHTML = "Removed Topics:"
							
							const ul_new = document.getElementById("ul-new");
							const ul_chg = document.getElementById("ul-chg");
							const ul_rem = document.getElementById("ul-rem");

							let topics_new = []
							let topics_old = []
							let erules_new = []
							let erules_old = []
							let chg_topics = []
							let rem_topics = []
							let new_topics = []
							let text_changes = []

							// This array controls which regulatory subjects are included
							let subs = ['Part-ARO;', 'Part-ORO;', 'CS-FTL.1;', 'Part-CAT;', 'Part-SPA;', 'Part-NCC;', 'Part-NCO;', 'Part-SPO;'];

							for(let i = 0; i < d_new.getElementsByTagName('er:topic').length; i++){
								t = d_new.getElementsByTagName('er:topic')[i];
								if(subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_new.push(t);
									erules_new.push(t.getAttribute('ERulesId'))
								}
							}

							for(let i = 0; i < d_old.getElementsByTagName('er:topic').length; i++){
								t = d_old.getElementsByTagName('er:topic')[i];
								if(subs.includes(t.getAttribute('RegulatorySubject'))){
									topics_old.push(t);
									erules_old.push(t.getAttribute('ERulesId'))
								}
							}

							let longest = Math.max(topics_new.length, topics_old.length);
							let n_offset = 0; // tracks the offset of the new xml iterator
							let o_offset = 0; // tracks the offset of the new xml iterator
							for(let i = 0; i < longest; i++){
								if(erules_new[i-n_offset] != erules_old[i-o_offset]){
									if(!erules_old.includes(erules_new[i-n_offset])){
									// New topic added
										new_topics.push(topics_new[i-n_offset].getAttribute('source-title'));
										o_offset += 1; 
										//offset 'old' iterator to remain the same, while we check the next topic in the new xml file
									}else if(!erules_new.includes(erules_old[i-o_offset])){
									// Old topic removed
										rem_topics.push(topics_old[i-o_offset].getAttribute('source-title'));
										n_offset += 1;
										//offset 'new' iterator to remain the same, while we check the next topic in the old xml file
									}
								}else{
									//erules are the same, so we check for changed text
									p_lst1 = [...topics_new[i-n_offset].getElementsByTagName("para")];
									let text1 = ""
									p_lst1.shift();
									p_lst1.forEach(function(d){
										text1 += "<br>"+d.textContent;
									});
									p_lst2 = [...topics_old[i-o_offset].getElementsByTagName("para")];
									let text2 = ""
									p_lst2.shift();
									p_lst2.forEach(function(d){
										text2 += "<br>"+d.textContent;
									});

									if(text1 != text2){
										let txt = [text1, text2];
										text_changes.push(txt);
										chg_topics.push(topics_new[i-n_offset].getAttribute('source-title'));
									}
								}
							}

							// Place content in HTML element
							for(var i = 0; i < new_topics.length; i++){
								let li = document.createElement("li");
								li.style.fontSize="15px";
								li.innerHTML = new_topics[i];
								ul_new.appendChild(li)
							}
							for(var i = 0; i < chg_topics.length; i++){
								let li = document.createElement("li");
								let p = document.createElement("p");
								p.style.fontSize="12px";
								p.style.paddingTop="10px";
								p.style.paddingBottom="10px";								
								p.style.display = "none";
								li.onclick = function() { if(li.firstElementChild.style.display === "none"){li.firstElementChild.style.display = "block";
									}else{li.firstElementChild.style.display = "none";} 
								};
								li.innerHTML = chg_topics[i];
								p.innerHTML = "<b>New text:</b>"+text_changes[i][0]
									+"<br><br><b>Old text:</b>"+text_changes[i][1];
								li.appendChild(p);
								ul_chg.appendChild(li)
							}
							for(var i = 0; i < rem_topics.length; i++){
								let li = document.createElement("li");
								li.innerHTML = rem_topics[i];
								ul_rem.appendChild(li)
							}
						})
					break;
				default:
					console.log("error");
			}
		}
	</script>
</body>
